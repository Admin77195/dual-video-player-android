# 双视频播放器 Android版 - 详细编译指南

## 🎯 编译环境选择

### 方案1：WSL2（推荐Windows用户）

**优点**：
- 在Windows上直接使用
- 与Windows文件系统互通
- 性能接近原生Linux

**缺点**：
- 首次配置稍复杂
- 占用一定磁盘空间

### 方案2：Linux虚拟机

**优点**：
- 完整的Linux环境
- 隔离性好

**缺点**：
- 性能损失
- 需要额外的虚拟机软件

### 方案3：原生Linux

**优点**：
- 性能最佳
- 最稳定

**缺点**：
- 需要Linux系统

---

## 📋 方案1：WSL2详细步骤（推荐）

### 第一步：安装WSL2

#### 1.1 启用WSL功能

以**管理员身份**运行PowerShell：

```powershell
# 启用WSL
dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart

# 启用虚拟机平台
dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart

# 重启电脑
Restart-Computer
```

#### 1.2 安装WSL2

重启后，再次以管理员身份运行PowerShell：

```powershell
# 设置WSL2为默认版本
wsl --set-default-version 2

# 安装Ubuntu 22.04
wsl --install -d Ubuntu-22.04
```

#### 1.3 初始化Ubuntu

安装完成后会自动打开Ubuntu终端：
- 设置用户名（例如：developer）
- 设置密码

---

### 第二步：配置编译环境

#### 2.1 更新系统

```bash
# 更新软件包列表
sudo apt update

# 升级已安装的软件包
sudo apt upgrade -y
```

#### 2.2 安装基础工具

```bash
# 安装Python和pip
sudo apt install -y python3 python3-pip python3-venv

# 安装Git
sudo apt install -y git

# 安装构建工具
sudo apt install -y build-essential
```

#### 2.3 安装Buildozer依赖

```bash
# 安装Java开发工具包
sudo apt install -y openjdk-17-jdk

# 安装编译工具
sudo apt install -y autoconf libtool pkg-config

# 安装库文件
sudo apt install -y zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake libffi-dev libssl-dev

# 安装压缩工具
sudo apt install -y zip unzip
```

#### 2.4 安装Python包

```bash
# 升级pip
pip3 install --upgrade pip

# 安装Cython（指定版本）
pip3 install --upgrade cython==0.29.33

# 安装Buildozer
pip3 install buildozer

# 验证安装
buildozer --version
```

---

### 第三步：准备项目文件

#### 3.1 复制项目到WSL

```bash
# 创建工作目录
mkdir -p ~/projects
cd ~/projects

# 从Windows复制项目
cp -r /mnt/d/双视频播放器_Android ./

# 进入项目目录
cd 双视频播放器_Android

# 查看文件
ls -la
```

**说明**：
- Windows的D盘在WSL中路径为 `/mnt/d/`
- C盘为 `/mnt/c/`

#### 3.2 验证项目文件

确保以下文件存在：
```bash
ls -l main.py buildozer.spec requirements.txt README.md
```

---

### 第四步：首次编译

#### 4.1 初始化Buildozer

```bash
# 确保在项目目录
cd ~/projects/双视频播放器_Android

# 初始化（会下载Android SDK/NDK，需要时间）
buildozer init
```

**注意**：
- 首次运行会下载约2-3GB的文件
- 需要稳定的网络连接
- 可能需要30分钟到1小时

#### 4.2 编译Debug版本

```bash
# 开始编译（详细输出）
buildozer -v android debug
```

**编译过程**：
1. 下载Android SDK
2. 下载Android NDK
3. 下载Python-for-android
4. 编译Python依赖
5. 打包APK

**预计时间**：
- 首次编译：1-2小时
- 后续编译：5-10分钟

#### 4.3 查看编译结果

```bash
# APK位置
ls -lh bin/*.apk

# 应该看到类似：
# dualvideoplayer-1.4.2-arm64-v8a-debug.apk
```

---

### 第五步：安装到手机

#### 5.1 启用USB调试

在Xiaomi 15 Ultra上：
1. 设置 → 我的设备 → 全部参数
2. 连续点击"MIUI版本"7次，启用开发者选项
3. 设置 → 更多设置 → 开发者选项
4. 启用"USB调试"

#### 5.2 连接手机

```bash
# 在WSL中安装adb
sudo apt install -y android-tools-adb

# 连接手机后检查
adb devices

# 应该看到设备列表
```

**如果看不到设备**：
- 检查USB连接
- 在手机上允许USB调试
- 尝试：`adb kill-server && adb start-server`

#### 5.3 安装APK

```bash
# 方法1：使用buildozer
buildozer android deploy run

# 方法2：手动安装
adb install -r bin/*.apk

# 方法3：复制到Windows后手动安装
cp bin/*.apk /mnt/d/
```

---

## 🔧 常见问题解决

### 问题1：Buildozer下载失败

**症状**：下载Android SDK/NDK超时

**解决方案**：
```bash
# 设置镜像源
export ANDROID_SDK_HOME=~/.buildozer/android/platform/android-sdk
export ANDROID_NDK_HOME=~/.buildozer/android/platform/android-ndk

# 或手动下载后放置到对应目录
```

### 问题2：编译失败 - Cython版本

**症状**：`Cython version mismatch`

**解决方案**：
```bash
pip3 uninstall cython
pip3 install cython==0.29.33
```

### 问题3：内存不足

**症状**：编译过程中卡死

**解决方案**：
```bash
# 增加WSL内存限制
# 在Windows用户目录创建 .wslconfig 文件
# C:\Users\你的用户名\.wslconfig

[wsl2]
memory=8GB
processors=4
```

### 问题4：权限问题

**症状**：`Permission denied`

**解决方案**：
```bash
# 修复权限
chmod +x buildozer.spec
chmod -R 755 .buildozer
```

### 问题5：Java版本问题

**症状**：`Java version not supported`

**解决方案**：
```bash
# 安装正确的Java版本
sudo apt install openjdk-17-jdk

# 设置默认Java
sudo update-alternatives --config java
```

---

## 📊 编译时间参考

### 首次编译

| 步骤 | 预计时间 |
|------|---------|
| 下载SDK/NDK | 30-60分钟 |
| 编译Python | 20-30分钟 |
| 编译依赖 | 10-20分钟 |
| 打包APK | 5-10分钟 |
| **总计** | **1-2小时** |

### 后续编译

| 步骤 | 预计时间 |
|------|---------|
| 检查依赖 | 1-2分钟 |
| 编译代码 | 2-3分钟 |
| 打包APK | 2-3分钟 |
| **总计** | **5-10分钟** |

---

## 🚀 快速编译脚本

创建编译脚本 `build.sh`：

```bash
#!/bin/bash

echo "========================================="
echo "  双视频播放器 Android 编译脚本"
echo "========================================="
echo ""

# 检查环境
echo "[1/4] 检查编译环境..."
if ! command -v buildozer &> /dev/null; then
    echo "错误：Buildozer未安装"
    exit 1
fi

# 清理旧文件
echo "[2/4] 清理旧文件..."
rm -rf bin/*.apk

# 编译APK
echo "[3/4] 开始编译..."
buildozer -v android debug

# 检查结果
echo "[4/4] 检查编译结果..."
if [ -f bin/*.apk ]; then
    echo ""
    echo "========================================="
    echo "  编译成功！"
    echo "========================================="
    ls -lh bin/*.apk
    echo ""
    echo "安装命令："
    echo "  adb install -r bin/*.apk"
    echo ""
else
    echo ""
    echo "========================================="
    echo "  编译失败！"
    echo "========================================="
    echo "请查看上方错误信息"
    echo ""
    exit 1
fi
```

使用方法：
```bash
chmod +x build.sh
./build.sh
```

---

## 📱 测试清单

编译完成后，在手机上测试：

### 基础功能
- [ ] 应用正常启动
- [ ] 界面显示正常
- [ ] 按钮可以点击

### 视频加载
- [ ] 可以打开文件选择器
- [ ] 可以选择视频文件
- [ ] 视频1加载成功
- [ ] 视频2加载成功

### 播放控制
- [ ] 播放按钮正常
- [ ] 暂停按钮正常
- [ ] 停止按钮正常
- [ ] 进度条可拖动

### 帧控制
- [ ] 前进按钮正常
- [ ] 后退按钮正常
- [ ] 步进值可选择
- [ ] 键盘方向键有效

### 速度控制
- [ ] 速度选择器正常
- [ ] 速度变化生效
- [ ] 视频选择器正常

### 性能测试
- [ ] 单视频播放流畅
- [ ] 双视频播放流畅
- [ ] 帧跳转响应快
- [ ] 无明显卡顿

---

## 🎓 学习资源

### 官方文档
- Kivy: https://kivy.org/doc/stable/
- Buildozer: https://buildozer.readthedocs.io/
- Python-for-android: https://python-for-android.readthedocs.io/

### 视频教程
- Kivy入门: https://www.youtube.com/results?search_query=kivy+tutorial
- Buildozer使用: https://www.youtube.com/results?search_query=buildozer+tutorial

### 社区支持
- Kivy Discord: https://chat.kivy.org/
- Stack Overflow: 搜索 `kivy` 或 `buildozer`

---

## 💡 优化建议

### 加速编译

1. **使用ccache**：
```bash
sudo apt install ccache
export USE_CCACHE=1
```

2. **增加并行编译**：
在 `buildozer.spec` 中添加：
```ini
android.gradle_dependencies = 
android.enable_androidx = True
```

3. **使用本地缓存**：
保留 `.buildozer` 目录，避免重复下载

### 减小APK大小

1. **移除未使用的架构**：
```ini
android.archs = arm64-v8a
```

2. **启用ProGuard**（Release版本）：
```ini
android.release_artifact = apk
```

---

**编译指南版本**: 1.0  
**更新日期**: 2025-10-29  
**适用版本**: 双视频播放器 v1.4.2 Android
